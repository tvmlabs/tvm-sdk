use gosh_dark_dex_halo2_circuit::verifier::*;
use gosh_dark_dex_halo2_circuit::prover::*;
use crate::executor::Engine;
use crate::stack::StackItem;
use crate::stack::StackItem::Cell;
use crate::stack::integer::IntegerData;
use crate::stack::integer::serialization::UnsignedIntegerBigEndianEncoding;
use crate::types::Exception;
use crate::types::Status;

use tvm_types::SliceData;
use crate::executor::engine::storage::fetch_stack;
use crate::utils::pack_data_to_cell;
use crate::utils::unpack_data_from_cell;
use crate::utils::unpack_string_from_cell;

use halo2_base::halo2_proofs::{
    arithmetic::CurveAffine,
    halo2curves::{bn256::Fr, secp256k1::{Fp, Fq, Secp256k1Affine}},
    plonk::Fixed,
};

use halo2_base::utils::ScalarField;
use halo2_ecc::fields::PrimeField as OtherPrimeField;

const DARK_DEX_VERIFIFCATION_HALO2_KEY: [u8; 1416] = [0, 0, 0, 8, 0, 0, 0, 10, 203, 125, 41, 5, 175, 82, 7, 214, 212, 120, 190, 31, 185, 243, 215, 142, 206, 28, 55, 148, 235, 236, 78, 11, 140, 238, 152, 111, 193, 127, 209, 34, 246, 148, 34, 116, 178, 134, 13, 42, 132, 18, 93, 32, 226, 39, 244, 96, 130, 12, 117, 119, 212, 217, 156, 196, 200, 151, 172, 135, 69, 139, 35, 13, 173, 122, 22, 3, 87, 174, 149, 253, 82, 125, 8, 6, 99, 130, 155, 9, 148, 61, 107, 237, 21, 80, 250, 94, 87, 49, 193, 199, 195, 238, 161, 41, 177, 214, 186, 206, 53, 240, 49, 77, 94, 22, 91, 204, 76, 36, 174, 89, 217, 146, 225, 135, 2, 230, 216, 19, 25, 122, 87, 210, 124, 124, 249, 16, 26, 130, 197, 199, 45, 34, 117, 117, 205, 215, 89, 135, 141, 140, 156, 57, 207, 110, 5, 32, 13, 23, 72, 176, 96, 71, 193, 134, 195, 148, 230, 34, 187, 25, 249, 78, 34, 65, 81, 142, 68, 255, 57, 160, 4, 94, 123, 93, 165, 161, 12, 212, 53, 73, 90, 46, 123, 226, 179, 196, 218, 28, 73, 48, 183, 224, 74, 169, 218, 58, 21, 195, 22, 77, 188, 22, 136, 194, 196, 240, 131, 102, 151, 124, 157, 225, 10, 191, 239, 224, 36, 140, 9, 33, 224, 44, 40, 7, 169, 76, 7, 204, 245, 21, 233, 77, 138, 22, 103, 94, 83, 126, 239, 134, 158, 113, 122, 247, 24, 36, 100, 146, 44, 234, 83, 133, 104, 28, 144, 189, 191, 32, 22, 83, 109, 162, 56, 199, 135, 240, 14, 79, 143, 121, 48, 85, 33, 43, 181, 245, 192, 149, 254, 12, 74, 66, 38, 131, 226, 29, 26, 38, 53, 89, 167, 254, 4, 180, 198, 11, 223, 12, 162, 34, 82, 204, 144, 90, 176, 93, 139, 253, 98, 29, 196, 138, 240, 230, 24, 56, 58, 1, 190, 128, 117, 107, 169, 226, 93, 111, 12, 110, 140, 203, 130, 80, 139, 14, 159, 217, 170, 56, 14, 81, 115, 142, 177, 32, 30, 17, 0, 171, 74, 26, 243, 124, 31, 233, 213, 72, 117, 79, 200, 59, 183, 144, 90, 124, 218, 100, 16, 10, 97, 209, 72, 77, 94, 170, 81, 226, 120, 210, 188, 176, 200, 9, 117, 25, 246, 74, 13, 40, 2, 90, 1, 6, 39, 122, 28, 116, 201, 254, 78, 151, 210, 87, 15, 222, 32, 170, 214, 41, 152, 50, 98, 82, 164, 44, 120, 170, 114, 200, 83, 186, 160, 20, 149, 194, 11, 74, 223, 99, 142, 130, 56, 88, 47, 97, 76, 146, 36, 13, 92, 117, 188, 184, 2, 173, 90, 21, 15, 87, 116, 210, 199, 66, 86, 225, 212, 102, 189, 153, 68, 224, 169, 121, 91, 210, 244, 149, 170, 104, 128, 209, 103, 79, 235, 30, 126, 35, 14, 15, 193, 106, 70, 48, 100, 161, 14, 227, 58, 238, 2, 146, 83, 165, 221, 138, 217, 237, 249, 117, 239, 27, 151, 73, 59, 231, 87, 72, 87, 197, 73, 25, 174, 133, 248, 43, 116, 117, 107, 221, 202, 38, 200, 221, 21, 217, 162, 61, 173, 173, 14, 105, 240, 150, 77, 27, 156, 14, 87, 180, 39, 154, 83, 2, 32, 93, 113, 102, 119, 216, 225, 43, 110, 42, 228, 189, 86, 180, 123, 255, 83, 90, 216, 207, 145, 190, 1, 163, 47, 202, 253, 37, 218, 33, 249, 12, 46, 140, 104, 151, 217, 119, 255, 46, 165, 9, 246, 95, 215, 26, 146, 253, 162, 151, 222, 149, 47, 235, 147, 85, 33, 185, 164, 34, 200, 54, 215, 11, 141, 193, 102, 225, 15, 140, 115, 87, 125, 100, 189, 246, 151, 138, 188, 208, 187, 20, 125, 65, 17, 125, 186, 83, 109, 113, 158, 154, 117, 228, 110, 17, 251, 52, 166, 130, 131, 155, 119, 207, 147, 17, 212, 10, 76, 148, 5, 26, 147, 242, 31, 83, 118, 226, 9, 64, 50, 242, 155, 123, 99, 68, 201, 24, 169, 155, 121, 13, 195, 123, 232, 226, 122, 71, 211, 217, 41, 88, 23, 124, 0, 240, 157, 45, 119, 25, 202, 167, 59, 194, 94, 181, 51, 185, 146, 21, 2, 8, 60, 38, 121, 49, 14, 180, 205, 11, 75, 118, 86, 45, 201, 223, 73, 93, 102, 161, 83, 54, 71, 142, 165, 166, 81, 27, 53, 114, 156, 2, 175, 46, 89, 143, 77, 128, 125, 138, 52, 166, 229, 173, 73, 237, 148, 10, 162, 240, 226, 149, 17, 173, 62, 96, 44, 202, 24, 28, 156, 125, 153, 10, 239, 43, 52, 47, 12, 209, 99, 77, 113, 64, 182, 3, 157, 25, 42, 6, 116, 82, 86, 231, 240, 110, 122, 38, 16, 229, 184, 202, 0, 104, 82, 10, 35, 142, 199, 162, 7, 102, 220, 76, 57, 102, 234, 170, 218, 69, 70, 12, 59, 186, 135, 200, 245, 214, 57, 171, 147, 69, 12, 82, 119, 28, 212, 3, 250, 52, 135, 148, 227, 250, 112, 221, 1, 121, 12, 77, 176, 75, 17, 65, 200, 67, 160, 154, 194, 27, 247, 70, 249, 196, 110, 1, 180, 17, 201, 43, 75, 92, 50, 190, 143, 206, 215, 228, 44, 226, 133, 79, 54, 153, 10, 31, 240, 175, 157, 115, 187, 131, 115, 169, 224, 127, 167, 238, 120, 161, 171, 1, 164, 205, 111, 20, 147, 168, 72, 38, 84, 217, 170, 119, 175, 24, 97, 151, 46, 164, 144, 216, 234, 113, 21, 222, 79, 94, 158, 206, 252, 82, 140, 0, 69, 234, 79, 98, 174, 202, 23, 38, 17, 57, 159, 128, 20, 229, 55, 113, 55, 104, 94, 148, 197, 144, 6, 168, 104, 30, 169, 209, 184, 134, 245, 11, 37, 49, 60, 135, 246, 100, 92, 45, 241, 3, 87, 27, 146, 21, 103, 105, 205, 87, 225, 62, 78, 86, 168, 68, 163, 97, 64, 108, 253, 209, 255, 7, 8, 84, 72, 164, 84, 79, 135, 21, 59, 11, 250, 122, 40, 57, 220, 16, 158, 28, 186, 177, 7, 109, 69, 151, 48, 94, 234, 117, 204, 82, 111, 44, 221, 161, 223, 146, 233, 111, 64, 22, 53, 36, 132, 93, 1, 98, 156, 81, 68, 96, 153, 69, 238, 198, 89, 64, 126, 220, 87, 138, 18, 130, 76, 19, 59, 143, 234, 54, 227, 30, 201, 89, 194, 170, 64, 172, 113, 130, 163, 142, 45, 76, 252, 105, 169, 219, 134, 34, 172, 206, 251, 22, 121, 137, 253, 3, 65, 145, 227, 211, 93, 180, 62, 236, 1, 34, 68, 182, 128, 98, 90, 145, 92, 232, 228, 12, 158, 18, 94, 72, 83, 151, 45, 71, 223, 151, 23, 29, 41, 59, 52, 57, 156, 82, 35, 12, 92, 192, 75, 165, 93, 128, 44, 155, 83, 13, 227, 29, 4, 212, 95, 92, 252, 89, 136, 10, 77, 138, 119, 18, 242, 150, 46, 39, 195, 88, 201, 30, 181, 200, 41, 75, 125, 253, 168, 180, 244, 30, 186, 213, 226, 232, 243, 194, 31, 220, 156, 105, 188, 122, 233, 25, 186, 180, 107, 94, 40, 58, 161, 42, 15, 90, 35, 190, 240, 27, 149, 10, 19, 66, 212, 199, 73, 41, 243, 130, 61, 33, 130, 57, 87, 61, 19, 9, 12, 249, 75, 68, 237, 175, 242, 171, 81, 76, 110, 91, 141, 1, 114, 83, 172, 119, 241, 71, 251, 197, 109, 125, 70, 136, 148, 58, 146, 245, 29, 39, 159, 210, 195, 40, 93, 45, 163, 127, 57, 64, 179, 111, 107, 114, 240, 167, 243, 249, 56, 3, 28, 187, 253, 39, 250, 72, 223, 14, 171, 157, 71, 16, 248, 9, 228, 158, 238, 100, 130, 113, 28, 87, 51, 174, 86, 65, 208, 232, 43, 150, 149, 50, 16, 193, 224, 80, 6, 126, 212, 35, 50, 22, 155, 4, 23, 1, 52, 119, 155, 137, 67, 103, 236, 193, 19, 161, 58, 99, 211, 68, 232, 226, 136, 112, 160, 224, 196, 86, 145, 236, 216, 157, 52, 250, 15, 44, 176, 97, 26, 202, 145, 250, 159, 127, 99, 161, 214, 220, 126, 15, 252, 17, 48, 65, 245, 244, 23, 80, 202, 203, 86, 163, 43, 155, 197, 170, 55, 23, 2, 87, 105, 47, 157, 174, 62, 154, 187, 27, 86, 16, 47, 186, 199, 79, 144, 41, 241, 244, 254, 132, 170, 254, 18, 224, 148, 231, 162, 82, 164, 41];

pub(crate) fn execute_halo2_proof_verification(engine: &mut Engine) -> Status {
    engine.load_instruction(crate::executor::types::Instruction::new("ZK_HALO2_VERIFY"))?;
    fetch_stack(engine, 4)?;
    let proof_slice = SliceData::load_cell_ref(engine.cmd.var(0).as_cell()?)?;
    let proof = unpack_data_from_cell(proof_slice, engine)?;


    let private_note_sum = engine
        .cmd
        .var(1)
        .as_integer()?
        .into(0..=(u64::max_value() - 1))?;

    let token_type = engine
        .cmd
        .var(2)
        .as_integer()?
        .into(0..=(u64::max_value() - 1))?;

    let private_note_digest = engine
        .cmd
        .var(3)
        .as_integer()?
        .as_builder::<UnsignedIntegerBigEndianEncoding>(256)?;

    let private_note_digest_bytes: &[u8; 32] = private_note_digest.data().try_into().unwrap();

    let token_type = Fr::from(token_type);
    let private_note_sum = Fr::from(private_note_sum);

    let private_note_digest = Fr::from_bytes(private_note_digest_bytes).unwrap();

    let vk = verification_key_from_bytes(&mut DARK_DEX_VERIFIFCATION_HALO2_KEY);

    let params = read_kzg_params("kzg_params.bin".to_string());

    let mut pub_inputs = vec![private_note_sum, token_type, private_note_digest];
   
    let res = verify_proof_(&params, &proof, &vk, pub_inputs);

    let res =  boolean!(res);
    engine.cc.stack.push(res);

    Ok(())
}