// Copyright (C) 2019-2021 TON Labs. All Rights Reserved.
//
// Licensed under the SOFTWARE EVALUATION License (the "License"); you may not
// use this file except in compliance with the License.
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific TON DEV software governing permissions and
// limitations under the License.
use chrono::Utc;
use tvm_abi::TokenValue;
use tvm_abi::contract::ABI_VERSION_2_4;
use tvm_types::SliceData;

use crate::executor::engine::Engine;
use crate::executor::token::execute_run_wasm_concat_multiarg;
use crate::stack::Stack;
use crate::stack::StackItem;
use crate::stack::savelist::SaveList;
use crate::utils::pack_data_to_cell;
use crate::utils::unpack_data_from_cell;

static DEFAULT_CAPABILITIES: u64 = 0x572e;

fn read_boc(filename: &str) -> Vec<u8> {
    let mut bytes = Vec::new();
    let mut file = std::fs::File::open(filename).unwrap();
    std::io::Read::read_to_end(&mut file, &mut bytes).unwrap();
    bytes
}

fn load_boc(filename: &str) -> tvm_types::Cell {
    let bytes = read_boc(filename);
    tvm_types::read_single_root_boc(bytes).unwrap()
}

fn append_uint32(b: &mut Vec<u8>, v: u32) {
    b.push((v >> 24) as u8);
    b.push((v >> 16) as u8);
    b.push((v >> 8) as u8);
    b.push(v as u8);
}


#[test]
fn test_tls_wasm_from_hash_for_google() {
    let elector_code = load_boc("benches/elector-code.boc");
    let elector_data = load_boc("benches/elector-data.boc");
    let config_data = load_boc("benches/config-data.boc");

    let mut ctrls = SaveList::default();
    ctrls.put(4, &mut StackItem::Cell(elector_data)).unwrap();
    let params = vec![
        StackItem::int(0x76ef1ea),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(1633458077),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::tuple(vec![StackItem::int(1000000000), StackItem::None]),
        StackItem::slice(
            SliceData::from_string(
                "9fe0000000000000000000000000000000000000000000000000000000000000001_",
            )
            .unwrap(),
        ),
        StackItem::cell(config_data.reference(0).unwrap()),
        StackItem::None,
        StackItem::int(0),
    ];
    ctrls.put(7, &mut StackItem::tuple(vec![StackItem::tuple(params)])).unwrap();

    let stack = Stack::new();

    let mut engine = Engine::with_capabilities(DEFAULT_CAPABILITIES).setup_with_libraries(
        SliceData::load_cell_ref(&elector_code).unwrap(),
        Some(ctrls.clone()),
        Some(stack.clone()),
        None,
        vec![],
    );
    engine.wasm_engine_init_cached().unwrap();

    let hash_str = //"f45dae3df26f2a45f006bd7e7d32f426e240dfd1391669953688cb40886aff11"; 
    //"25dc3d80d7e4d8f27dfadc9c2faf9cf2d8dea0a9e08a692da2db7e34d74d66e1";
    "f6b0cc30d023d266819b16dafa5a6a6ad25b97246bbbca80abac2df974939b87";
    let _ = engine.add_wasm_hash_to_whitelist_by_str(hash_str.to_owned());
    let mut engine = engine.precompile_all_wasm_by_hash().unwrap();
    let hash: Vec<u8> = (0..hash_str.len())
        .step_by(2)
        .map(|i| u8::from_str_radix(&hash_str[i..i + 2], 16).unwrap())
        .collect::<Vec<u8>>();
    let cell =
        TokenValue::write_bytes(hash.as_slice(), &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let tls_data: Vec<u8> = hex::decode("8fa2d869e938a71a2cd1d1eed76c82c133408bf07d49f5e6a5768d518c8ae72c010316030100a10100009d03038f73f3532eb8b51bfb5f88dc2cf559eb728751d67e458dc067fc49e2062e52d50000021301010000720000001700150000127777772e676f6f676c65617069732e636f6d000a00040002001d000d00140012040308040401050308050501080606010201003300260024001d00204796db556e029e1b98b0e9be06d4c23ddde853c627f1dfc52b9e3103b5f1ca0b002d00020101002b0003020304160303005a020000560303c99f389e5ac8e8f3181e4804b70c89036be8d2cc7668e0c1649c78e66ce17fe800130100002e00330024001d00209cacd9c4e8bca9041188341a5bb347d1cc86012614432bcc192cd129d17d5c20002b000203041703030be7d99a04ada3091a4e87220816628a2f76033a4b3e5bb0d7c6515993d0dc6e49cc68bbe2724d973ab450c7e312cf513f9cd2577682873feef58531782bb90ce37aaeb62c1005568bf5d993c98510ce51099cf76cf73d9e54c33e16e747f97688d83b5b1d7274ae2b3eadff5e5d209f86c0af37b81a1ba00e3451397b8338ddba20ed634503f78ebf2dec7ef350b806d47c7e31c5748f2488322100171ca0313d0bd8c5460e896c664f3e593953e7fa6394430ba064c28d26686444ee4ea1eb67aced42070ba044bc999e9e6b56b9256407297bc79b6043cb92e4cf0bab84ec0755a0c5556d8ad7b622bccd3f3322ee0c16f7e3a7d17b5c82d80241e5045a400eaa4814835867db2858bb988797dac15f633c0aca926e5496b0c4572fb0947a85b7d4928db482a17b79052840cf080b0c25cd219da7301b2c766b88980626997448cf9ff696b90e8262852ded638b96e716b34af40d01785fe34c1de91739ab7cbfe7579fdb67bc7ffff1b187de962da204fcf0a00323ae125662f19f0e427c35383b81826e7a0bc7d89621d589e074ccc0470103d0c271394dda1f72ae52a61997754608a4ac42eeada12237a416968de797095792d7c26f1a0ae89c02ce9f88501d8474a4fb37aece4c696d504a265a3303f1af4e3641234ae8e6fab4a2f466eb43172a3d3a12ca714ebb5624bfe0433ed54b17ee90d8b5b5577e470db6bf1cda0a59f40c7f4872b766b9c8cfd27ee2d6be5d73f17aa92bc586b0da97ef2443d5d63140e45f621d4b88833fa2b9c34398ee2c4510ee3b5fa56008f2e05537486e4f0c6c3fb920b1d0724f92d1210213d5e0cf3fb4b090268243c2386a32d1d0294a52c00ba16db0418f2e4626ffd1f30d90c76aff0b1bd3250ed2fa9a437ce229bc673b506c1a017ec56b0d53e40f94020e44fa6bbd3f5b31e3aa3fbc741da5413a5c055ea2bf8a7f928054fc26a261813b5d2d247851b2a5df4aa3f577a5999342a77e9c35c811914e2a80eabe77018f7218b285b97f204849027bad55eb6d0d0746a3bc7790699dde1ff17e32fb26aa27b7f92022db3b12b65c290060de578a79d7de62fc4b16b43d8a1e1cc8f5290023a9b4021537c5fe488ce9d48aa596957c6588cb31f90653ac75d6b3c0d5beaf01064a9e6631aaa2fe0ccb2fe8296e99a5181af90e893e29ec5aeee44b568d5d78d445dab932843be6b0bae4e87e04fd0a574f7f63a3d7a9b311b99b5c824f20047453060e13d441edee8c12d0644c730e04eaa15fbb349c338861e5b67d8caa2df839a89283fade6b9ad4f3174b301e8e5a7550c720ba561cfaddf864259eac6465b955fe4c83ab9bcedd8509abc2c814be18c1045cb0c9ca08f154eac9baee5418b638ec2162da27515a85feb1c983a0c867650819f423d4fb27fd345d5ec63e463d07b484be14eca45eb9cdad05942d67a44b9e5966749b0a695c3c1cb9750ec3275b3d1193eef1eba4dcf9f2985877ab7c1c68c1a7985ec859f66ab2a7480c9fb24adba48b3b1a1e74b36b405c40cfbe0f3a2d9eb21b9c1074c42c633b90863d10d317db0ae7bee4523d1b7acc6310f1134d24f51cc4f4572bf0eaf097c470456c45c293aa3639e255853c9621d7555a759787b8819dc2e945927af9bdebd8a471116a40decad5ce0a45517954f97edbb760636958ef529f241fab7eda69c904c914090f915fc4fbdd4266a34f60642a01d3537616f7cc0739a1c07dd046048c6f55bf6a5f521cc957aa97bf9483a7512d41872b76b9573610b98b8874f77771c00ebc937d0c587989e7ea5b1c0b727b42100c26c3d808a811c2e57b3123f145eb035ba9a1bff4c555be2762cc1595e5797d081ba5897c260778932ffa694345059c35094f8e4b0235111fb916ee8527f7e38a73af562cb846ac55f1bd6e638021164a91c93acd15b2b90db95802406d8d3d6a7c8b6817dcd84eb4cdabedb162c827dfd86ea9525b4d21b8d350a8900d156fe896d76514cd75cda5080215093795bf8c15629af912aa8987a8fed60eb56ed17b0b2c14288f77db57b6f79dcf888b3407229ef2eacf950e138ac7b0a86f04dd27ed1863cfc4958d95349beb50ab4b1049413127a3071dfef124980cb738ef41435e8fa5c9b7d38cf274f48ace0bc73048e29c7fe1e22ae0b786d066eec46229779ef43fe34f4375edac2c2967ebe941c1f9c54c9456c9d2a134a7da80faf65ca3681045f81e4235cdde3a899b90d2519d49fccbaacd47380fe56ddc277b05293cb63fbe86459d9f0a887cf17e9d7b9c88c0ecb0be853ea9e7e83ebd78e10dd2396c50f76108cb6ef5cb9c6992cd20090c49b7c63ee258aa452b9fd507766c0b9ca0c512761ff2ce1acda26b07aaf35b4c1c4b695326f18205883014a3a456afbe1237b69f6a447e1b471e713da33c6ca333e2c76ba4edc521acd6aa7f9342b8c8da2e4b72c3b89497caf40a5eaf53398aada0630fb715fa328f261c9542d0d2a67f7548ecd76a6c3b46c965ffdfd926129b5a0e64048a3df4bac29440e2cf8c0a0d4dca25ff1df5bc0a683b32ed3e01f12710ad2875d644b47bc51d9de32d9754207aca629ab9bef6086a59d2cf789e04a38a854f586413ed0f2c634a88dab6d6dfd76e7cd02c314a765b727b049f3926cc53e6453c4d4bef9c7fa04f4abedd0b553752713453307a6b094b4249efab7d68590ce3c64ef3d7373c90951d611eed2c68d8734243e0f1464becf04fa6a4cd2a72ffd1a1069ecfeb1837732acd723dc3ee291c380818ff2c4ceb7ab375dd6aa18596f55269889af34d395dbb2bddf4491b5a7c41aefe65b1be73a501d1c03f1711af1c4535df54446d774ca01f213ff01910a05e3542682768f258e1625e0a197f7f509c3cdd61524652759edd5206eb1339c858ab78a34e32dc3cb330cd619ec8478aa8a6e3c46181c6bfd396d63d7505fcaf9189719fbc8715fce2066e644952fcf146ae66fab35445d299e4d44060f4dc5c76993bf9388b22a0d43ae9b723bc265b2d258387928fce27696746ed5f25f65011089be5d8040c0bff0ffaf2e649f22853b38ec6b70c62e4a90e45afa0bc357ae7ad90c0cd0f9a1224a6d05c892a47e860e249e2af53c6b6016a9212ed7d2a897421971fc775e27804d4e4dd5116e180206a1a4e32f7283020baf73441a7a575110202222b2ee5a2011f18571439ffaf334445424f5b4d8487b1faeece0524f6208765fc840d3d11c864f219fc323da4ce07c30dd2800d3da350173b3fe49b2635a687fa09e177004f1b3f1d83d26905d380bfc8b266f87bcdb2adec175a8aa26dd386362992e92678061a312fc5444a2d3c2b73c0c3159280bb59303ed0f8fd91cc3d36f9ad687fc96b1984e9f607446c0ed6d5b5c4d6ac9728041c013ae25dcf77893157fd245ba2aa60823ac3c9e1930bddf05f6d7de37a6fd05529e67bf836e133c98e5cc0ac8c29bf9af8c8a9b4ed82ab4e2be8e02a2a2928def2640ced0d76c7162e5ab17642257435bcb24b27da2d15e39cf5dd78506f66cee3f4ca01581e38d36312ec21d1272d97a40d9041790e0372b6007dd09e7d6aca768e1419b669e17c7ecf0e5e65be20a29cc77481451947d8dfed6559ca75f8e9fad957f53a1956e85f87740ae154aa9ab30cd5b2ae26a9a0d1b2901982403080889e28721cdac49228a306f19bcaefbf493c2e3199e51a409282725ebb2ccfb7e99d9ff92090433b2b7ad1d2f04fd5fcbc8abf4438a73eb4e42e9414b032b234dc4ca70ea74f11545a5ccaa5c6e7fe506f8ece85fa8858573eb31239bca2b795baf7a27f301621d906c5e1dc3b52c2a926eb22cb17d609f328e6042655a86d9194c331195517f72923aebcc3cdf3f174bd0e764e32a9af6b5e4dd518836b458261c7b6161410498bdb43e819b35800444788e67b0c651a63ec4eb0f77c9bf0ef68afc6e62128bceacfba13a47e023c6faaee3c619e471c173a51c2cd4411a9f34e0f4b5fbe84345c60e74f84e5bb75eb04ace1b10405ef5ae608e214a1e39838b9bd4bc76ae5e444f6f7b48c1c54a29bf84d5f911f2ade92193d7dc02fda263f72b2b3b6baa5a4fe5f3b8c2226106673c8e8bc626597e81d56cbb54bf8b3d68342d8ca72b505f3ea6c3e95c0fe66a542daee5e5487a15ac96fb4099cb0d6112c5b897a534019e4c3ae54f82a910f10d757144e6e0242b3f64bc32f3f1fc7d2dc5ac779c60b63b9e7138f0126748da64905c0868c36b5c7bbdad35c078e7b2dabe66dbf2412473d38571a97ff497e715d16c184e0c310a44b2b2584c4becb2b059716170303005f4eafe9ed8c935f7725035adc100422c722633aec99bb085ea3d32b87206b330e3f31f51e7db76dc4e2a0f562c5634cbfa72da16db78606f1fc383531ce789e78c19d50a01db91d2d19e54359e83eb1bf78b445af18e5e68afd985a5c92186917030302172c4cc8ffe4658b5ab9f57383ec481daef6edeb8b2ef176a23e0305d37f1c8af52536b5bbe8e339b079881ffaca7ebd9ef3deb4c2c5b5c9b8847a8d9c2ab436bbcaddae027d0396821bc40314f51b00f904228a338a02607af2bc0eb3ae764fcee80cbe155941c1ad7e0d2b20efcec20b49abb30fd9a20f65a11d6e27729bbdd206ec082f953765a763a31968cb4c34355d071d677a409c31b35c2d101294c33664cd1c39292757e19d05fa6b5fb0c0c2c1e4ccc62c8315e61dd91a9c200c459e37612efe313334bb292a56d0665a2ffcc9fe3ade7943d8e6bede14fd6876327891493eae251ec57be177b893eb2ec8644435a106ba4202318448fc07fe821b622dce71405720e8ec1789f4a9ccf63f399d201831674201513b09ff27c3a2b89d13415f5343ab5c82495d692be6326e08faa4b90bf1bf09e5317ade350b2250b92e3750b87ef140fb3c6dbd72ec72ff91263c0221dda6c8327cccc5b903c554c7e431e87cd01c2c64f9c291b8687102305ff2c2ca1105ab00dc4c54cc035183da20294fc6a8712d0736de196a97bb38acdaf356ae1be2e686aac5eb04594c814f8bb93b83b28e59b8d51ec414d05b572c6c28e0aa6b8a8c0474c928b983f1a3a83e6ad9446f61cc1ced7b54e46d0db2133d6deb01eedfc6aca335d7d64519b601f7784ce9ba8f99387cf65a0f40dac80198795e178e5464a32bcc0c57a9e5a408adfea63680c7b9ccdb1c863d1df16a14f13afb5cafd14617030305536e49d346e03977f3e0053e968ba2d88969e3ad81a462d887e67a2a93dddfe2d7436e22781ceaf7e52c2eaf190c37c25e4bd16ed79a256b057086a49a8507841741f490f372b7fe5b75d97c1190c87da8be4e8785acb1572eba94f97abfc545d8850d709b4cc94b12b36bb9da53706fc1e7b6f3c5a0eb16af2693799659bbda0fd0ee8106d980d016eea154be5ec706749f58bafe3812ab8936b3ca2a35020935ee72f4f93a09b21aec5fb91d3f5b39331d51df4e7aa7b4230ff2de7cd567c53834d2b927ba2d54612422a127ae6ca89c9891968268983ccced3f92018371698d8cd681ce7a00c9c33fc0935aef41b7a57ffb7d89e7a3ebf24d23564a97643fd6d2ce9f5106cafb10edee21772a9456ea8b666f6c8cba750a518cbde33145df9b409cf74054595f47e4fd62521d49fd8b7a48c18693f4560d5997fc442cf1cb70983a4a3f506198da10cca030af9bf5ab3f9d4f0f39dd92cea13bee52d27f19cb03927042607b9be06bf2e53e5c4cc16eee7ed17b7700bcca4972e3f682f24a40cd3b19a514b2fc8d09551a29e6864b8cd852c245f9267422388176e0c4c83fe483d2b2f7398527022076ff9071d3fc206a4b22c0868523afc1390ee0094df37bebb8096baf93d95986b72065bbedbb38f32dcf32a62d2a717c959a59f990fc2de93a70dcc0f7593d52072c2b5f0e49996aae8239217ee732d341fdcd2d810be6ddddd22276c09a46ea1262b33dc342c9762f000eaaa4e8bf545e54bb2b998b5c76f9ac5a81298fc57f9f5e4ee7b925f8b134dfdfa08de3067584af0e86e8b9745955b4e0e209fc453c4a87ae62a482172636ed627982af9d80cf26749c9ec9d920054fb5042a7c0d46a0e6c010de55bdd699e8bfa62a690302ce956b9ad6ff9ff4653918be4eda472d4b61321eaa3ffefb43f0b430c65b8b9156ba2730bffa6899f5f03d3c3e76ced6d1cf7dff663b7555aa5a8fb589d7e61b4c1ee8c84deda3b80410f3045d5cd8c76180bdfcc159647d5594c7d921312568786b34d42896f18116fd86f3aa49c421188a09f77a7ade07ef0ef55cf85a1416f8aed111a179cce8c0068f26e101720793240eb1f4988108fc39b26e8ca5c87430c5e2faf77104fd2233e178359618190a280dda9d3f06e414d9098b97d093b573ae8b34b1fb38018294019415e5ca04a71269d28ccc29bdcbb2a41def67a512773b87f00e30f315897f20332ec9a02081472fb8a7a9dd0f9fbee92e7da301bd39c6ba7405994a551ea054a78fbe8183ba82fd93c300ea88e3c587740238cc7e9b6c03c4e66ce37a4b9fac14c2b49520c4c4ae90a8defce4f5050d5218dab0c7052ec7f191e438b290aa3884e39b9162731064e2129a8a4b92c710f3ada848854debbd30990fb5d10f494138f09ebc2918384348e7fc6eb04dde09fc90a1595199e90ebffaf0de390d8abf93ac0894f8f14a61c3915276df375a73d975937d82c60e719b90c139793bd416237ea5bb023f2917ef4c984fe8f62e5d2c2b2f354c8d12422901ec7727a150687e2fb56f4ccfa9c3d8d5c189c53f0a5a504a2bb54f2cf82980f832dde951025e731b2bda8caac33b773d1bbe77226b6bf643288f303d060834566b1abeff996789d27c8602a388b1564a0deee991e672b36232d08c09fb812604c32be9ea5e618ca3e03c174bbcb75ad210217c3241fa1b73edcc902bbddb9a0b57f64060b0156c4ca3ffd0f6c0a27b220c183cc2e4a6d70ed71930f0c3fe98ab82140df5ff0ac7ef3820edec0f8fde890a15045c1848b80f4bb0ac7e5bd03d8ab03b97c20dd404e485fae2e51827c8105c536948e309f0998dee252dce110c6c3ad93f0afd05467df874b0c7df80e19aaaefe02285a3e0eef41421ad6dd9a2450967f4b11d06df1a9e351490119bc099fff2592d1917030300e47867a00b245092c645c3d564267c357379cfb308045e64a1da1bb749dc0cf016baa8c725b2a87b569aa0c551fb3bb03eaffcece061248749c3be0ec8a01ce0cd7e0b03c97b2f5a836645e924cd91aacd7ae2685e2eaa1cab1bd4822236c9c8c86fa27e38bf73f64e0ba8e27998055aba324630dff541cbffbb71cd2e0b0ea788976535e4c5782e9b50fc61f549b2577ff31bfd7da9201da840a2da5aa93e8eb4191a665eb423f87ecbb3f731b8d43ce84c01ac68b8696babe333dd76fc5fbd9e51fe1c4da9e9d22a1217d6f262ed5767460c6bf6a65bafb7e85fcde2d1d3fd6a10f0cb9c").unwrap();

    let cell = TokenValue::write_bytes(&tls_data, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let cert: Vec<u8> = hex::decode("020d308202093082018ea003020102020d0203e5c068ef631a9c72905052300a06082a8648ce3d0403033047310b300906035504061302555331223020060355040a1319476f6f676c65205472757374205365727669636573204c4c43311430120603550403130b47545320526f6f74205234301e170d3136303632323030303030305a170d3336303632323030303030305a3047310b300906035504061302555331223020060355040a1319476f6f676c65205472757374205365727669636573204c4c43311430120603550403130b47545320526f6f742052343076301006072a8648ce3d020106052b8104002203620004f37473a7688b60ae43b835c581307b4b499dfbc161cee6de46bd6bd5611835ae40dd73f78991305aeb3cee857ca240763ba9c6b847d82ae792916a73e9b172399f299fa298d35f5e5886650fa1846506d1dc8bc9c773c88c6a2fe5c4abd11d8aa3423040300e0603551d0f0101ff040403020186300f0603551d130101ff040530030101ff301d0603551d0e04160414804cd6eb74ff4936a3d5d8fcb53ec56af0941d8c300a06082a8648ce3d0403030369003066023100e840ff83de03f49fae1d7aa72eb9af4ff6831d0e2d85011dd1d96aec0fc2afc75e565e5cd51c5822280bf730b62fb17c023100f0613ca7f4a082e321d5841d73869c2dafca349bf19fb92336e2bc60039d80b39a56c8e1e2bb1479cacd21d494b54943").unwrap();

    let cell = TokenValue::write_bytes(&cert, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let lv_kid: Vec<u8> = hex::decode("927b8fb67bbad77445e5fea4c71aa9846d7ddd01").unwrap();

    let cell = TokenValue::write_bytes(&lv_kid, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let current_timestamp = Utc::now().timestamp() as u32;
    let mut timestamp: Vec<u8> = Vec::new();
    append_uint32(&mut timestamp, current_timestamp);

    //let timestamp: Vec<u8> = vec![0, 0, 3, 232];
    let cell = TokenValue::write_bytes(&timestamp, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    // Push args, func name, instance name, then wasm.
    let wasm_func = "tlscheck";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_func = "docs:tlschecker/tls-check-interface@0.1.0";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_dict = Vec::<u8>::new();

    let cell = TokenValue::write_bytes(&wasm_dict.as_slice(), &ABI_VERSION_2_4)
        .unwrap()
        .into_cell()
        .unwrap();

    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let start = std::time::Instant::now();
    let status = execute_run_wasm_concat_multiarg(&mut engine).unwrap();
    let t = start.elapsed().as_micros();
    println!("Wasm Return Status: {:?}", status);
    println!("Time: {:?}", t);

    let res = engine.cc.stack.get(0).as_cell().unwrap(); //engine.cc.stack.get(0).as_slice().unwrap().clone();
    let slice = SliceData::load_cell(res.clone()).unwrap();
    let ress = unpack_data_from_cell(slice, &mut engine).unwrap();

    // assert_eq!("0100000000689fabf7ab8e1f759972f2594613044e4a197c71d4f3f541d7e2afaba98838c6d2e031e330e2fb0805dd8ea233cc05ae3d1d52ea11d0db3ae013e30b1f71808448606f90fb06a56215f57ad962829f36187e345c60153a92f9169f9de61ee7feb5dc6eaadd908e93790c729ab17a3ee9276f51cb0081e5a7d03dd76717ca596bdfc183fe5309d70b1b9cbce2757448b8577d9d1a00c30f56de34e5524255c8a51b0bcfa5d7661dfab69b7ed0e200629687635e769f43a8b2b0251d23da93753dde5b8873898500c85ea72ad05c9b3c1d014106ff21b12495051c87ed593fdc963578a73023b3390e88c39a3941ae443be09fff2a4d1a36c64c2e439ca82bb1dea584f325", hex::encode(ress.clone()));

    println!("ress: {:?}", hex::encode(ress));
}

#[test]
fn test_tls_wasm_from_hash_for_kakao() {
    let elector_code = load_boc("benches/elector-code.boc");
    let elector_data = load_boc("benches/elector-data.boc");
    let config_data = load_boc("benches/config-data.boc");

    let mut ctrls = SaveList::default();
    ctrls.put(4, &mut StackItem::Cell(elector_data)).unwrap();
    let params = vec![
        StackItem::int(0x76ef1ea),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(1633458077),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::tuple(vec![StackItem::int(1000000000), StackItem::None]),
        StackItem::slice(
            SliceData::from_string(
                "9fe0000000000000000000000000000000000000000000000000000000000000001_",
            )
            .unwrap(),
        ),
        StackItem::cell(config_data.reference(0).unwrap()),
        StackItem::None,
        StackItem::int(0),
    ];
    ctrls.put(7, &mut StackItem::tuple(vec![StackItem::tuple(params)])).unwrap();

    let stack = Stack::new();

    let mut engine = Engine::with_capabilities(DEFAULT_CAPABILITIES).setup_with_libraries(
        SliceData::load_cell_ref(&elector_code).unwrap(),
        Some(ctrls.clone()),
        Some(stack.clone()),
        None,
        vec![],
    );
    engine.wasm_engine_init_cached().unwrap();

    let hash_str = 
    "f6b0cc30d023d266819b16dafa5a6a6ad25b97246bbbca80abac2df974939b87";
    let _ = engine.add_wasm_hash_to_whitelist_by_str(hash_str.to_owned());
    let mut engine = engine.precompile_all_wasm_by_hash().unwrap();
    let hash: Vec<u8> = (0..hash_str.len())
        .step_by(2)
        .map(|i| u8::from_str_radix(&hash_str[i..i + 2], 16).unwrap())
        .collect::<Vec<u8>>();
    let cell =
        TokenValue::write_bytes(hash.as_slice(), &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let tls_data: Vec<u8> = hex::decode("bd62af7b4abda14c1a8e2de59364dfd225c6d30bd45c49fd5556992d7f4859eb0103160301009e0100009a030374226dead34132f11dfd7e5fe08e011bb91926fe78ed3ba387c4de667bfd8b6700000213010100006f00000014001200000f6b617574682e6b616b616f2e636f6d000a00040002001d000d00140012040308040401050308050501080606010201003300260024001d002029e69d5ab866f392dda683a51268f20360ff39aa2fb16997c4c6f3e2ef0d244e002d00020101002b0003020304160303005a020000560303215f9fe849e28f9be1d418315196e4c614277e0b510362fdbe0710f365d01b6500130100002e002b0002030400330024001d0020c5e4aae8ef0af5e71ce73deff4f915e1b023b9dff2807966f658cb867f88a8741703030fdf66a70b634b965d412bbce8c042a7ecd7b57af649fa902a4e5219c1da65e027ce200ef8b4b0e69de80c3a353e66872c9210829994cf049ac5df48f143548d2246e4abaca6222535df09a1555230cb2b3d0f03cb21672fdd023550637fc5febd7f8995ccbfb6d900045b88f19f49b3dbc58c0122c522549ba98f646d6815a5356e28e9ef443ba08826090cdba9213e7e059dd5bf5282a768dd16ce466941cd7db255f2639bc396ed851adf090ae6067eff82ddd52d3d64c17d41290ddb318bb725d9f94d4c1f1ee2c7f6601c5309b70d5a84b3cf2602ad934f5774300aa0b7686867c0cd2da5e41cd98dd8c2667d28d736a0c77699017b48d09706be9b30730f70fc71c93115f7c5cc554cc897f1ceaed6b68970f324448f24339fcb9b7acbfefb3dc41bdb9f3907aace79e5e03b2fab57c666e5ced8f557f181a2b3e62fcb6aabcc15c397b4aa3ab39d582f79398c6e6346e09093930ec6738ba0e4aeb939f12e4cc859fd3d53e84f938d89b1f7dc60f1afc415cd4f80ad1cc5fbb994ec8620794463364e898cca3b19c6601180b2bf66a740490cd397d568c00bd3859c392d3ff3b057e98c1af34a4f8b733470d9dc82991e1b783bd3c0bd0ec663a6a310ed655c3e07bda4a414970ebd85d366b6b5da9b3841e0666883988a535885deaebdac1215dbd652251e90be9d58f8533fc1f27a8659ca4c2d4f0559b839bede2b62d1228ecfddf4e191c3cec264cf87e286493dadc941977d83f11f53d835fd6116386209f170cc8d396683038e823b617e2fd12a478dc683f6f045d3ea1e8362b914ca1b7839e5ca27374c4a4ef1245905708ea2c4bb011c86ab1eea288245bd6f2d0add7206c1ab690b028082eb8e0e471a828576e489a8aeca67e5aca70c9046caccda4310cad9483b800847154c14dcca4edaf41b9d6b30a2a4f5ec600b5815ebf2a552333ac64dd238354bd002aca4a98e196104acdc815d7e0130e0b349e1c759a51fbe4d607bb3eb4d806e72923ef25d73cf98fa59b44d61b73f2bfb8044315bd287c23152fa4dc8e7dbeb5b5f3aec79627a52cbe60b579382c885134a690e79c5955bc7ca91c218dc5b69eca00c8edbf7e70b23a51b0d59a3b13ec9e9724c0e60d0e584352c33f36d2a2107074802ae3148764c495bd964f269a8543cc85c149092487584682a63fae81c0fa2bdc8c7594aba3c188b04f1750679b0aeefa61e84a3d13bd4eada4e435c02df79ae51f18b115ae9570665607ca30276a6ba987f613fa4b477641cce4174970e9215d1d2efc03c050f6f2a674fb2e83ecb0db539ee7466d028eee9fba60d748a82dd0cb674b1b091d898462a67782ee0abba8ce83e47d9ec3a7c670b29f2e95091561c35db09279fa057e0ecbadf6a9d1f365c6469cb59df261d61388148492aa3dfb4a35f1fd0079755a01d33d90ba0034cc00e48c464b0f690b44887f7fb8e08087bf6098de6a5cad5bfb602be11fb7bba57ed78bd686cd1997346aa6aec818d6a3596b520c39aa94c8675152ca28310d5760b4243df3e1d3efdacce51c7d9f6a14f6085d8477a027ac88faf60229c0941409f66b4ed3b44c19915c73f1ea2a52808c02eadc3930477c5becdbfe3cd426acf209e042eed065119023ad9d6106db2efb65c3624a2c1a96cf5b111a7ad42f2f5e44832823f7bd264aca8d1cff40ce635a6495bce4b044553b262000fb81f8104e58afb7bddf96377816354564372dfc1b50d9729b4585e1824441c12e88101cd0153c6107250d372c8fb0e3a89e04ab82f7c15ecbf1d9eb535c25c50694c287a74166ec4fbb2ab39a2ed1f382fbacfb3979c4930a5fb014bb82c348d02e241ac693ef99965f25cd31fcc0735b6090b51f2fe59afdd010f0a59e82031ff13bd50cfeb9e13851b687198a11541f5e4047f5c2b813e095f04bb500734b41cab095c1d0540db025759139eabaf898b9f34ef137d7604448c65521f38e48b9ebc1772ef9d0db8f74aac42edf87df4a56754312608d2317770eba12acb18be1eb51ba8ed438b7b1d7ad6ed5b595327bb3d5e100a6fb7e4a2264cb7a5a88103ca627c5381d397ba908c38b7990b385731f5010feb766622ec0bdc9626ba8a4056168224f125f6de49f8d1d6fa19a1ed34bb8ced8b42e65d752906660d568d338a4ce59f6892bdb75d4680bf62f6989faf4e79fea0de8cab55d52965f7161bd36fd53f35775136b77d40cd310ad6c794087ecbae8b5bf92c4ade00ab8a908ae57013f63c1e856a874f47b55b60581ba6b4ca56c1c0f5e2e1dbb72a2c6c8f9441bce566b085f3f6d3c2a71a804dc2555c75ae90e5f08ac06f81cc7a2aa983d16de709e017405a220a63a87cf91b4f30eee83522ca83363a1715f208d9b218482a4c49598dda88f2c37b0a5b1a0c6e1a8f5b52644471f481f96345a9d7370de71ab4bfb0b03790926aa8dd7a99d95f1d2314e69077415516ef0517a880080f49d71537339ef756273e39fb7c06c3a94459be867f7b1eefa0ce9fbff4f4486f52b1f399f27f94b54f69fecf713655ef852e4b376599eed03b2cd7209a56c059d96f30dc1c0165ce5a881414999fa8d06b3d8f37eb00d9aa1c3ecdcf4818f48257e3251df6873d81c5dd0b6174315e5503adb3b86a92ac42e86776f524b70315dfcd6eceb8d0be01e6dddc9f30ab607ad59edee08cb46b0325eed3682806b83ba9ffc131eda9c0fa731613fe807e0125cfdfe68722512bc8974c326fe5f5f95ab4670db344c35dc1e26452ef6d3c3ab26e1a75aed403696ba1b7033cc777b804f700fea4992f67fe6a4d077d5d3496e5886dcafa8396cd43d17868f0067d24c09f58e1893841c558310c3958202a34aa0325de04bc3751072c1143dc7e07b0c38ef17bdca2eeb1235868d80e3f2df2ceebfa2d1752b0b77afefe868bfa6743845850bc697ca55516dd6a4ae3618efed7b12dd947dd0f65b6c975a8187bb994ae1c1a8c9b30ff1ff3618efecb5a1d60fe369881d7c7aea8f6bc772dc9bfed4eb66186ec4cfb90662843cdc75a5f228a47d25b0e013eb78db4551d8584ce8837986185d7567dc468aaad2dc6456a23a31295ce39038cbb4041cd78ac07f33fa9a53578e591aca0f783b12d852eeef2cb4addf092024c1701c333ab7353640c6b3164b0f23cac2c499a313c45adffe061606b43101877b65d94a8d903c759759ae9e19884b1cc2048928145fa9e2a62d0b2577715bd03d19770e4c31726872843c8b26ea8a49ec77fd34f1572f30773be394f5716a41cba2ec8b7d8ba79bffd139e08b16bb33df61389ccac784cebaf978c58445e3b9525708e48491882d37b0bcc855edf47ccdddbbf4d02b48795f0adedfa502aea2f9307f49c7d9f53fbfc05cae21ae69e72e93924b89a60e8d041362e3128e55842f77fc98e97881cbed679a940efdb1ce6aa5daa0b4b4d5a57fe9f25673b1ae8690a4a25d5c9f86457bb70b93c90a0786e682ee64c7a764a87b130b6667e6db9f46dfc489204a5cb8958a731fa27931dd123db1e2e32f307f5dcb9887602f8d2989d6f27806045074f511720da8fb2539c3d666bb628d5dad4c3b863f4628dc64672e21070b579e972a95ecc930d957959663d6ecc70bc856cf0c280b910c2bf75a178f3d31409315cab451ee69053a7c67713c7ec1761f039f9c87090075aef837e93f2dc0f2aab99ed829624de52c3372e4d4ae3700e3c62b69ba0194776ffa0802b7e8597afc2b5a7f077a676e4934ff12bae6a43dee436b793b9f3c39a5ff4c2c33f1e84e7b3f8b99e2447101e43a39d65d43560ea04d0ab9ba9befeba0c30ae6a8fb8df78d9d13de94370fec93e7148965ea1c0a5bf27048bf2f83b5dac10f8213921f1636748d17d9263b93dc7cfd90c64cc442790542cf3d0d7ba28535696e1201f3c78d0349d65b1fa11d0e41aa418513247a2dc2623437c1d02ca849b4e6102f86b6aa0f339b78afe5cbcd0e142c1a92dbe490226599b16598a9c0fda70def5a08234714ef695cc7e85476e12f0899594735b0b4c38a3249f77aad01fed8c11bb9d87e4b1c905fdceedbb6e5a6ccfe5468c9f6b557cb5dcbb74234d69fcc5aa8da36ba3275ba7150e1e8008f16e8986f8b70b4509de5a8c47539a71feba61e7fdcf2f5ad6ceaa16277e1f4b1b3f6f2a042af840276229f52e47dbcb15eb76a41bfe68aa0abac5b0744aa59d0c1a7759aa43b3bd04dcc10dc12b4b370de6c154e30902e6bc5fa6bd9bbb609e7e767f81e1741d6a39f963a67846351c98feacc3564d5a82f4b460bbe8b373d5cf37917a4b32fa34ff90e4d2e27bb1abcb139fe18c19842fc6e743ed664abd6a8236cd7422d1c3befcc11883919084a2b5a5165982b8f1b722bd6ca8723022fce7effbb046fb203ed873783e44bc4c3a9d7e32a06a83f3cfc1424c72ec1d4bcbe7aa9db64f447ab05e161a6c8e6d241079e841698bea908afb9624c2457fd300ae0c9af6acab52159ded8501813e2ac36036baa643ec1549d4b7ed5029d6c22b50ce924506f22cc10adc8ea433b734a9113e6521b7c11c6ad8ec334239c0b41023300cc76732aa99d00ec5784a2192dfed4009e840f2ebeb86570100eca10126d0ee551c11714b7b20a3501774e317d5f17a92034589ec1bb69be9fae41f05f0223e4c53182797d65d1fed71d20ecc60473b9bd016d28a17c611c8cadbfd4cbb72b787566a90d660cd0cfb875b00494d773d99d3ba777bee72ce2a8dd803aa17300a88b1251da2fce5212dc923c25c5120e131f7cba4feddad98dd621f234531360e6cc9a46cd1e0c79fc260823a2ce098edb4585e85e6bbeaa5975fbb3d7536cebbaececd1f51e95b53b13f11c62f170b7c22a4a5ecc00542bd9b4d44b867740ef637cc67ebd84d22ca94430ee72be7080de1e9412972478a6327b9db0660be375303c6b01b70e40c8076a4d54fff50cf9f6a49f094727d70547b29890ab5ab2e9c45ded4004db8c64f8d0c5338f6cf067154c36a20394fcd2757a50a84420ea1b29109c5e5e816ec41cf7581a7dc735f5c22cbd02d1a929d471861734792cccde54e3be90756858e0dfa5d45a3ab1203c5c4fc52d5222a9ce75abbb2a87b3bc0a9201b5441275681423ecb0bef64f43b0ba9194e5c5c2684298d91017620e27c045ad2125dac6c7f25edc94b92184bd5e243c807c1f265d80f0901bcf2dbebd8b17120d8afb82db327b027fa9b1fd44c7b855c3e27703e749cf1f588f63709ad2f792ecd907736115eea511cc24891425d2c31a2bc4f18715db3672ce80e3f9f73f3376d159c6194062a7659b523ffd1101485854b0ad8884c7eb32024972e5237081ffd1b9c72246b44ee2142c917900611400d1dff1d23d2f6f6c543747a76cd587caf9db4f5bec6905286c0e331bfdae2f7af9b3d0098d33fd22eb4170c624999d970fe14f8b793f09fdb5232adbccc400d18170432d511cd104649a86911742146f1ac0a4a4fb4577e90d8415e7315714abd8d93b2b17a5bb62aecf61bb6728ad4d6d58744ab4221992f9b4580e7de86d55a62d386cf7da5c1f88cce1ef304818c3d919c1ee754022200d381bdbb9e1b65a62130dbcdbff5cbfc97e33ccdf48ebad6f362642024acc450307039746199fac804387c36da6fcd58802c7d1ebc0654d9fe35bf375958c5bf7ca41b34b0156f44beedbe9b2411527e9438f250aeb5a4c9bf1e13143cf765e9d9a46ccaa3f54c37c4163ea1959c3aa5354175ca170303006224d774d2a94257a380fd4b33a960a0b169f328bc95a94cfdb358a7c31bcfd1e0471c2ee7634334bb4b342c4df557f360d27ad58171d44ad84dd841bf22aea6177e0d3d1142ba22ab3b6061fcca96cc24ab0a970f3184ebc020c5bf7ad57e6760cb69170303010a742fae76841730be2c0bfe840b1ef82df13b074aabc05d90523155e53642ebe9aaa662c146fb39887aaff3659ef525ffb6972f2679ed1983ab6a6fb91b701a96d5efed76cd4b97e22de5a3a174ab59b809dfbe99e02bf57a1e209bf21a610977c38d9578fb572048ee4ace6eae5e778b72b50c1651be79c3510c779eae795cfc13edc2779a40d3e03ad3692e0b779ae8e2984a15f3abfb41124345e0883954514d1f2b9645f163fce7c9747a122cfacbedb7376199f3a7c5faa50ead621f7548fd9c1e4f350e1c4ad99451a30a88e8a2498b189c79927e26f5e636b44830e0ce30e0084c70a1c31e731c402095c1633f5b7a6caba5f52c10f6cbb42929ab0259fb24972f653606bd6610170303010a6aacdf7516af9f80d33d238cd94daa62448130b89bcbf1ab92724ac27c1b624248afbdaaa0eca5bd8d77f15d2e4ad50a985aec2a8c32807893afdcb731727310acee3e4c022e888dd2577e2c9d945a61e9e8a14b53681ee177a7e3efaaa67de9d1dd14c0b45691e2e89cb46e5fc4f723af785fd0225920f6037963c6b0c0c361cb200de8b7b75e997541cc1bb7ca56314c96125701220d936fe109f35c915dcf3c5c088443b9736c92430b1776464a0e3a74170cf172672a57e1802238d2096762cd57a5f9d7cda5b1b55041fb2f08a0883b9e865a3d139cfb50a62f4ecec7211e60ddf1364a8181d6407d40488120329d15b97df7074a4093f75a17988b06f40c39c452c0e20f40973517030304e8c821a2dd1b606f14ae011ad0192376ff83622f58c5bb49b05db75db2ef12355db37a2cc35cf94b2e6c17ee37062ec933f763b77729412e98b8ff400023d4ce062ee835bbad53fd778b5e9b3ed0ec6ece1a47802c3cd3ba63a011a3ff52b01a0d7f39301e5311e19e47b81c98923237294372c69debfd953f88fea8c794cec0bd00d5a151f86fc3ccf15ff33ddc19f17190fee6412a8f323f7d465cb44612a3d60c4b32485f3b9bcac9f4c9de2045eb8f25cb9534e7903b51523d864ba60aed7d2062d780febd06e1b8509306c3dd63cd84aaa322657a62f6607e0699f6ccde434f2d925e2004971da421fc2d71997e425186f33f70dda905144f283708c70f57e932f02386493745e41d1058afe34385aadf3d1fb221b01af931685ae3b53f73de7e8844a3f6b892dc3fa0ecd87d72d4982e8027e65ca7e066bbf8e2cdf7e8bc6db8676673dba8ef8495648da4fa2b077fd6e5607818b9f8cc75437a44430a4466f1cf1da7547d611fd303f42815853db6ec52b270a8ac602e15fde86f37fc0060b19556c500a17ed80d87992026b1cb4b2dbc5b00542aaae7367fa886c89aafc14c2c71f558e920501d95afc84eb74a314894a04fa0464986105c8178bed045d1a6bc36edee86778366f0b60cbd792cfff8478d422363107fa63358af1fae4d8053797bcae9a402194048d0152d761e87228ff9ee7be11db4953575bf88e399bd5c2bc278c97600864d449dd0783a55b439574032abbc7e0f12a667db3aaeee488e063fea4d161a43c6868606909dee9a309f0cffdd26d6a40ebb34e64b193cfade16ba7b106c27f06d15e2f70fbcd728ac53dfa0218cb48311735b2454961d4be46aa39b6f1ec265d055827889512f8c72b707e6f2983aa1c333e478646a632085227145d940e11e05cc0b965d3475dc372b3fdc32120d8ef85e33c2053c42b5d5a66ebde50b841b282edc2e49727ba15e0e05cb025731f444ba916db7a1adbc91de2db7d0e6637ddffe69881baad76c9dbb0aae35673e136c7ed76b7ef2923330ff0d6c48786f5af478f8bb8f4d34d1490dad8b3e2b55edab8403fc64f0b31b4b5ad0f99b17e6ea889155aec83e1c1d6f43c0378bb26a184ed5cdd057fc395ccd7cd42ad703826e21ca7568bf2f3378e1cf61e1b0601818dfc6e6a7beef63490d984c429888260a68bd0d4bf5834998911a28c651e9c7f6f6d8c5acade15a9def4eab44b585c64f331869a745ad801fc28b3651aeb7e276c2802e760a57bd4f5fdd873920e5cc310986408f1ced9733c02aff9984e10c641483db7f9ffce7aba400021496a3c50b17d92e76f9d1fb1b6b8eafe4b741a2aac6471671c688a65f71bfa972c44ba4fe0d12cbd1050017b2ce0b9b684b4cbaa2acf57b59fa2d3326801f9479c1d9b58b55a18033b282b2253045059e9d8ff9e37d14533b97c15ef665866c4aae8a9eb47d5ad282cb1be7dda6fd9b4affc0341ab1126239aa5e7269f5ae19c74fcc57ffef6fab51524955a935291a7d85eba517ebe3982b207a8cb2abf5f4802784a20bfd45cc788ad7403f1449b95e98eee82587a6946f0214ec745b1a1b8c0bffe5e0edd8b927d6ff712289388730e77e7f452f42b403abee183ddf029b6888b2c1ebfa826b322e80e9c71930ed6ecf626d8d4f1e67ed32735a13aa90c093882f04489e78df1b7636536ef1a1f06d0833a34b6b996669712f6dab6a10d1fbb814b44e6c5d50217771d0f41ee62fc3cdb90c4f6c83997fcb52ce60e5c9cccf5d04bb").unwrap();

    let cell = TokenValue::write_bytes(&tls_data, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let cert: Vec<u8> = hex::decode("03923082038e30820276a0030201020210033af1e6a711a9a0bb2864b11d09fae5300d06092a864886f70d01010b05003061310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d3120301e06035504031317446967694365727420476c6f62616c20526f6f74204732301e170d3133303830313132303030305a170d3338303131353132303030305a3061310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d3120301e06035504031317446967694365727420476c6f62616c20526f6f7420473230820122300d06092a864886f70d01010105000382010f003082010a0282010100bb37cd34dc7b6bc9b26890ad4a75ff46ba210a088df51954c9fb88dbf3aef23a89913c7ae6ab061a6bcfac2de85e092444ba629a7ed6a3a87ee054752005ac50b79c631a6c30dcda1f19b1d71edefdd7e0cb948337aeec1f434edd7b2cd2bd2ea52fe4a9b8ad3ad499a4b625e99b6b00609260ff4f214918f76790ab61069c8ff2bae9b4e992326bb5f357e85d1bcd8c1dab95049549f3352d96e3496ddd77e3fb494bb4ac5507a98f95b3b423bb4c6d45f0f6a9b29530b4fd4c558c274a57147c829dcd7392d3164a060c8c50d18f1e09be17a1e621cafd83e510bc83a50ac46728f67314143d4676c387148921344daf0f450ca649a1babb9cc5b1338329850203010001a3423040300f0603551d130101ff040530030101ff300e0603551d0f0101ff040403020186301d0603551d0e041604144e2254201895e6e36ee60ffafab912ed06178f39300d06092a864886f70d01010b05000382010100606728946f0e4863eb31ddea6718d5897d3cc58b4a7fe9bedb2b17dfb05f73772a3213398167428423f2456735ec88bff88fb0610c34a4ae204c84c6dbf835e176d9dfa642bbc74408867f3674245ada6c0d145935bdf249ddb61fc9b30d472a3d992fbb5cbbb5d420e1995f534615db689bf0f330d53e31e28d849ee38adada963e3513a55ff0f970507047411157194ec08fae06c49513172f1b259f75f2b18e99a16f13b14171fe882ac84f102055d7f31445e5e044f4ea879532930efe5346fa2c9dff8b22b94bd90945a4dea4b89a58dd1b7d529f8e59438881a49e26d56faddd0dc6377ded03921be5775f76ee3c8dc45d565ba2d9666eb33537e532b6").unwrap();

    let cell = TokenValue::write_bytes(&cert, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let lv_kid: Vec<u8> = hex::decode("0f3f96980381e451efad0d2ddd30e3d3").unwrap();

    let cell = TokenValue::write_bytes(&lv_kid, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

   // let timestamp: Vec<u8> = vec![0, 0, 3, 232];
    let current_timestamp = Utc::now().timestamp() as u32;
    let mut timestamp: Vec<u8> = Vec::new();
    append_uint32(&mut timestamp, current_timestamp);
    let cell = TokenValue::write_bytes(&timestamp, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    // Push args, func name, instance name, then wasm.
    let wasm_func = "tlscheck";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_func = "docs:tlschecker/tls-check-interface@0.1.0";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_dict = Vec::<u8>::new();

    let cell = TokenValue::write_bytes(&wasm_dict.as_slice(), &ABI_VERSION_2_4)
        .unwrap()
        .into_cell()
        .unwrap();

    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let status = execute_run_wasm_concat_multiarg(&mut engine).unwrap();
    println!("Wasm Return Status: {:?}", status);

    let res = engine.cc.stack.get(0).as_cell().unwrap(); //engine.cc.stack.get(0).as_slice().unwrap().clone();
    let slice = SliceData::load_cell(res.clone()).unwrap();
    let ress = unpack_data_from_cell(slice, &mut engine).unwrap();

    assert_eq!(
        "010000000068d1cffbabccd9d1bfcc35a2dde8dcbcc1de1c8c5a268a52df14865c9a1352735b6dc7fa10749259b790831c1f165b03c60540d4c98f0099f8254bd635a80d3f7f1c6cf9951676de398d26d4c6084a358804c12bad7cce6c44e877b2b9b94e22d6e187cebcacad196d6bf5340474b7bdf28ae4f3eacd4583f26d123748aa2aa5c8b59b540e72f520e3111846f6d921692edb80cd3127a17b2b4a533e8d8b890a3959337c6375d6b523d48ae5451f8b340f55f596267a8cb0cb7934ebaac3e536991e8af96cce60233b7507816652e1484e95ca190652e479ff0a4f0181cf242d618053c4f398eccb7913a8b2a284d1e649e0448b3089936f65d2119b8dd701722f456d27",
        hex::encode(ress.clone())
    );

    println!("ress: {:?}", hex::encode(ress));
}

#[test]
fn test_tls_wasm_from_hash_for_facebook() {
    let elector_code = load_boc("benches/elector-code.boc");
    let elector_data = load_boc("benches/elector-data.boc");
    let config_data = load_boc("benches/config-data.boc");

    let mut ctrls = SaveList::default();
    ctrls.put(4, &mut StackItem::Cell(elector_data)).unwrap();
    let params = vec![
        StackItem::int(0x76ef1ea),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(1633458077),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::int(0),
        StackItem::tuple(vec![StackItem::int(1000000000), StackItem::None]),
        StackItem::slice(
            SliceData::from_string(
                "9fe0000000000000000000000000000000000000000000000000000000000000001_",
            )
            .unwrap(),
        ),
        StackItem::cell(config_data.reference(0).unwrap()),
        StackItem::None,
        StackItem::int(0),
    ];
    ctrls.put(7, &mut StackItem::tuple(vec![StackItem::tuple(params)])).unwrap();

    let stack = Stack::new();

    let mut engine = Engine::with_capabilities(DEFAULT_CAPABILITIES).setup_with_libraries(
        SliceData::load_cell_ref(&elector_code).unwrap(),
        Some(ctrls.clone()),
        Some(stack.clone()),
        None,
        vec![],
    );
    engine.wasm_engine_init_cached().unwrap();

    let hash_str = "25dc3d80d7e4d8f27dfadc9c2faf9cf2d8dea0a9e08a692da2db7e34d74d66e1";
    let _ = engine.add_wasm_hash_to_whitelist_by_str(hash_str.to_owned());
    let mut engine = engine.precompile_all_wasm_by_hash().unwrap();
    let hash: Vec<u8> = (0..hash_str.len())
        .step_by(2)
        .map(|i| u8::from_str_radix(&hash_str[i..i + 2], 16).unwrap())
        .collect::<Vec<u8>>();
    let cell =
        TokenValue::write_bytes(hash.as_slice(), &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let tls_data: Vec<u8> = hex::decode("e7e2bd80afc02ee9a0f3e3a8baaecf6f7c1506dc129b121127a5cb6c6d0328ba0105160301009f0100009b03032dc8c0d5874b3cbf0cddbd2640dcccbdab5bb07be335fd1c3e71183648611cd70000021301010000700000001500130000107777772e66616365626f6f6b2e636f6d000a00040002001d000d00140012040308040401050308050501080606010201003300260024001d0020c042385f065681d91ce805b16dbd8b9a0603d73ecac3d6eee7529dc66bc85110002d00020101002b0003020304160303005a0200005603035a4aa2325e1ed84a2681c7ac895bc072ed60f41269b20f4a83ccf21890b7853d00130100002e002b0002030400330024001d00202a1b8a9b82aa6371c30f0c992c5874359d175bd820d7990f51dfaee05d0ad7661703030becadac1a77cb455a80280804bcb8948cc66a66f650d9d802e3c0dbdc52d75d0bf86d5e12302f61f0ac0eb10a188a29b4b6756791b4b26baa53ce1daf9ce68df5eb7a571dd5a96db566f807390932a6d0bf0dbf2f5016d130e52357dc7960fbef15e1b8b870821976e79c622d753c39a09f92299c790298c0a67a3d9e5c7e9e14c487dfa68de44353cc2469982ac6c268c592c23e9e6b9f5a52f8a3536509d6778804ca3c163790b9d5f7b93855ded448cf52378a33cee8323d615850b5e97600e1edc61726ea8a5eb8dfc9c279c574457e237378e4d0bd9369e2342ece143e2db53e8b394cd7d426bc234dc3b5419441227a159d362ef855b37b9ef62f8b7eac1cacf2936b37ed33394e7a995f43643d938b2fb1499c5b6bfd63b382dde1083b66aa038cb047e8b023dee0ab58f1200aed33aa2aaaef4ea0f070bb1335545e4e93d269a0965ee9ce18c31d68166454e232e81e8e8d546454d4e88c61ddf2ca8ad298ef6d592df1f5cde415d3963ea52e3eb06ce738e238f83830302b53ee0d95d088a4188593c5a377423557b7f01298ccc4f5fe149c5bae7b318f00f76af743af17a0a41d154acfc32e099ae912b0eed54d33442c5543a3438effd450ee69445dc10b836f4c0a2351b09744c55c9d40a0c880a5cee2a55bb499e914fc309222fc24ef333f463603887e8125ec932f48acafe2e067221bdeba219d99d4bbbdd1076ab11c277f53ee86f0d32bc4ff6cb8372877c25b75e86c53dbdddff197397142df939ea90bbaccc7b9b92a94b15f363aaddf3b849bb9b28cfa2182ca8931f5a2229260b5469d93e9ca3161918a7a03800aae72dcecf98a940533dbf1f07926a2b49940574e0452492c81f1523bf2296275640baf84399dfa086ac2b0dead99d88743666fb9cc4710a17ff535b1b21dd106f4d505cb4cea9ced194cb9c94171f24c03e7e219e572f9167da868638dfe44d6ea19ba50b232c6cf1a5d88b4c41ea8050d84dd54e68238f08f914a0a471fae70c4f7fca1eea71c7471037dc1735839dc1b81d9bc0951a53501f7b5ba5699be1a23b6d76e37ad82e5a124bdc7e53e8e48bf981d6642bd3e2f63bcecbb22d69dad2d26cc9690bc6efa85c369295eacd6df814596938f56fe4dd9da0a6ff6a488391ea3b8b82b1629c82791bef5211c6a5cd769cd73607ebce32a329140d57c47509f672c24e97b6633191e375e4d52c260e1f82d1d7bad598560fc8fb67ec6237372f8cb9209535a75c4226d240793b699331d14b069e8e2ccce66befa94de120606ddc5429fc00774dd7fd1a0f9aa4a90374b1ea0190dbbabcb37356cb2f19011b88837a0eb4ae41afc611b2ca6821ebacc08441531346329363f9d6a89a06eda125a5694d52f70f4934b4c64a285463d78f2140c4357e62395f80b4a291736658f18427fe586196514967529eb073220e43a35210acd20c981d861513060093da9b35f691b2883b526dfbf81ce11dd1c7cd4433c0066f6d690d7640055d2625b1697009c3b45c4da4316f86ec5ed9679dc37a0403efcde4cb328a4c5345f18bd134293d557da4eaab3dfc6f866c6870eafa066341c886ef9ef5466c738f1645c7680a2a2d532f89fc0270f93aef81eaad26165d294717b3869700c0cdcfa4ed47774a283c84924eb5ce4aa42d0decf9929464fa40a4a96fb4247becd10267cca0213cda0ba74a67d50670322da22063cc1936e6633e1b2da3bc16aad712cb905fbd700501f4f2d69923279cfdfbc530d0c6d7ab8f91b3726610ae68146b3c8f5876b5d674f1541d2e448daeefaac184c97bc5ad2f8b19d35f9c7fb9aca5c7abddc0a938d5def6238a6e29ca215d89d0f77a3f561b9abf0d39281430d3bbde7572f14d536c1b782a60fd5468992addf68f3b6e585d2210a914bf308f3e5d0f050256bf3c142f1822c86ecc06e0e9464bb095f406dceea5ce4c2a04dc8072a49d4b5633ea3fce791f9bccece59aba0dbac7f4e873bf72bb1f61bbfe355d677153305a6e3ac23620defebf92b4d450873f8772c9cadaafde832427ab44bc298b24d3de27598dcee7c45ae0fc21a4633d70d72d5bc658e7321f7fabaf42de308025574f7a0acf3649ec4566f17ae8fccd3a57332d7977e053f3b17ba5cdcd9134d3910142fb48b590f621a0892c949e76378fb95374666a6b78d80ead17a71ed24d4e0b67501dc56863b91118202fc277f8e8759abc3b088e6497d98b5b47b3931c8a1dd17c1cfc4ef21741f29beffdba097434ac59d44eb5717dd87a7d99f5a49e7935e556660ea48816173a052ac43ca0ef5ccfdcfcada2d368ae3c54a288eb0df852090b82af7294b855c8a4321c180a187b4ab0628a546b90abda7b4e175736297b5729805f6f10b00a7d91f1e99e1d0b7cbe84569608eeaeb19d748c57bcb264a65bfa0d216640f20e9965c25fa9895063847df529d0db9b67f0229f7736cb2516b941eb3319ad0044be0047c70296ca450b963ded18102d9d029ea8b3473ffc260431ac94a22b2fc033f9fc162c55a1ff8fa417c6f4369dceb88c52d15d0243824c8ce6e8ee62345776e1ae5806a3bd57be792bc2dbb40ccb55b4d2512586dfb79d8211489e84161af418044767349393087ddd8c103c85d0c548abb00ffc8ef879ad6208dd70e908c9fd5f5d7e28e021e0ec9da4db905d856ac2918642c97a0db855dc096bcd382d446670e1a7f3454bb44995fe00e7392b33fa8a40bf8dc60ca56d979d3f958a8b1538857eba9350edc9cea85163989f674dde32905153963ac7bde090e4fbf846c245907c28a30684d9a03731528ed393a9c814dccb0c9073876dbd728673a8d9ebf45e65120bd98840b00f1422c60c5cf5ca0036338a5a5f0a0d0ba6ace4baffefe6dd1b87f4c25716bd97f1ff4a78dc21ce1af2a7f55714eb2e60ccf7064998ece7b91f6d6db423ce669f6959287d1cb4dc6930cc775128c25ee2111abe8ffe27d558df2de3c0787af1494d5037e2e865c218aef3b48a58f49fa507713e009a0de6714e074ccdd4611c4142bab55a6459162e0376069f9cf723cc35f250fa57a85bca74e0a3451a291d18b394c4d9f1b75f04e42a4ef1b124aa50230f884bda82853d59ce132b546f15c0468a86e63869c9eaa85630b67db9e8fbb0d4416dee56b7258bc416b21cf65e5157186ac3fd0c2069225d2ceb2e44f1797c3e2c0bf6865037ea29a834599a76a5e2ee9cce4f6bf5fded847f7c1c442953a4218a45e659d58d5db9d4b4b4267969365c9bbfad0f0ecae5f0a6503e55501afaea152d556bb229edea876a4c88f074c6a96d82e862e26cbe17c147b36cab506f6fab176fe7ad7c3da039905a4f6b0509dc8efdab62f1694ccb2c6aec18c7945bf6fd3cbe98a4f4eb07e6673d57af617ef1c6848bbdb274f03c96af48fe92365fbd4940d0a639560c6f2046af54e24c4c18dda8f439c0efac4226aa61b9b06bbbfc741af7b75c7471a79263406c0defeeb08b3a2457ea8b59e0ae694d14a8b24123b49c5c0bbfe43def6acdb09b6df3f0b1edae26300978338a3c7001d01d5fc0223d170103b0a793c3cf156acaca021bc3e5e5c00b48145d5db8669f4681db836d856462c98c2a472e2fa4d4a3698bb2175169b7adead7764fd2450d832833b84961da9f017f7d04e78489b1c993c6e676f07371d640108a6a1d867f980ef36aa3d40c92cd48a6f070bac568c67493588a6802dc23ec73c765319ce3809294a2a86c87ad4085e5941a19efc59816527e36451af117ca7f6bb95d0e85fdcf420a2f65e76b543ca6b4532a55e92f16bd72f24cb510dc63e0be52f4e8be09c322675845d40d681d6d10f42a6ea1b70a6cc04dd904ecd3477eb43af0916167dd3b33f08432d5b92c9f69aedd89c4eef815970bbb0d6dae6b702266f56ca9a2631f9e6daa57369aaed29fb59fe71c7b6cf7b1b863f8c10c66ef23051e08bf0e7c2ca16f39f7a182e742682f6ecf3ef92310d617a97cdc38396c778092524e8110477ad3e6a199374aa52d734bf2d73f001a033cb53f01cde1d50ac9d474ae73cc03b15e010649bcbf6d8794fd56c224b095b242c2a7c6d0e028ce989d14295aefb33498b4fb6af008e8245f183ebc9ccef2638da9cd834145778827d7684c7d8d45858d61bbc08e1bfcf49facf45a4b4fb7689c9a8066879bd3113f0cf77ac82f75dd30182b0e71dab1555df60e3d9f8982383e4ddad24572bd62090da703e352b91d1ad6f2e7f05a6a4daea86c85bf6a4021a6c31e3e9e49e02cbb5eb088002b410af82d4a78054e8d41da6dadf753d9a5723c8927099fd170303006c3287d7c9f3141725bdbbe8be8c87addb5dc3d85238f8f64b3175e4153f91feb8af939943f8ee15f8fb46b3bea2e9a83ebb35c7f671ca78e6631fd52036054ed909f2676c10815bfb4e1de8510454d64c9afc730d030992374e5399fd396e2783ca31e968583bdda7d5dc26ee17030300a45bf40628b417cbe1822febe8b6cd75e52fb3241202fa0aab980669e3bb7243f901ec9600c0ed29a3272ba07a53ec43a0d182e476f6cf061868318443eea2aaabae1076fb0a7e40501134a6810a8d61e12ecffdad4533de6614c7fe87b3b5bcb5f58d7a57295f78b90f32dff33cecb301738b46136bc115caf9f2e88f29ffd9f8013d8fbfaadc0ca061e99fd51560d319d216000bb51e48a02c0ae56798d9d1097d2a006617030305ed0b123f2959e7f823d9676f99cdbd6e4bff6e42ae84834381d488cc11432d3b436af3991c9ad83e82daa20d48bbb2a520b3688cf46782e2356fe8a9b411101a8cb15eb56aa77edee9387bf58d301b82345c2b97c67ef9c5c4f8a17c2c538f1fad72b560b7bb275780c096da8e4817e5598a73b1b7fa89ffbc13ca8dd9e36cba1a3e99f2bc270c6cab43d39486167731fc0f4e7ebacfe2de929251006e0cfa54dfe7c86f3df6e6a46899a306446220670e029481159771b43a126afdb92c6411d3649b17cd5be7f0f4d8026849679ff75e78831816f676ac2f8647a7f061dde509e5e3d155252705640fdf006439708c75b7b50f73a5b8e7e0b5279a5b696f94370451647c3cc2b8233cfa249f38e40db0a8d71454326107999447608becf84e718dec55966b93e7a56ccd665bd352d01f2beaf15cda3f3f88dfe064cf0bc2460a472ca61e28bd3b799ecd98343d7ce9534eed052c67ccaf32555dd57de1e2e008b37d773c992b317671964313ad3b4b01a124ef9e63a7f29a8c82613405b990a3a3654961008f01fbd93b8e40f01845e5ddf286654b9eaccba90762bfa09c78759aa4142f2f39748797d32fef85a88b761079c0bc10d3a279439bb5ecca66cd742b6509c100caa16e85c50ec9df0a5cab7f537ff51ee3b92cc51a39d025e79ddbf21392eb04952a706412bb6a8192fb94bc0d55a2ce600ae6f29b60da1599fee52e927364a42ac25e17cc417777c39a69d2e1e71ba5c995255af5e37bfd024cfe13916ef0dac73285b0c5de73463a63b6e0d7d2d57cc8725bd98edf35e48d990d1afc95ba8ee618a22f94b4f493eb0cd08e382b7b6290c81ebb29da452e2e455501a7c29b0f7f261f721d1e8020cbb4a9550721b4554835a83115309977acf97d61a77f7f5f478d94ee1b504c924cb59b3dfe86704124acde1a0b49dea579b424ba1fcd4625707093458cc4d7b7c782a0f07a3e00225dff0a37c0a7f26f49e5b2ac755ddf81323d85f9cd61b95f558c597465ae17fb6dc2c07158479e7c02c93e7fe48833a9ac3558517f90d45fae5d78663839dd3bc53cf896e77885d6aff3c8537f0ca1044bbc713fd568ffd8d44bf716d6cf59295f674dcebdaa3dc90b4a9a4b9f7dc63054224f05988111de516c3ec52939f71ca66651878ad82aa6abd7db93f548a64cd05f4a3c5afdc1389246c30e7f376023c43d7f89de9c1f0baf66870f462fb5f73718f93f79974f623502cca2fe66099970e7a7eca3ee6b9383cca19cf55b1ccfd45a658ddd693b7ceda8cb43fcfb46a9a5c932c58fb0e12973f17ddcbb412002c362a059eea2ea93d8a26324f20b587afb6cad6d5353982e5aa33e50babd0088676f24a52441178fe5b5b355034c5fa574ca8dca2175e58a5ba2f5489d688f1cd3d6c3eb305ea7994bf13f16941846400f4223098274bd4b1f6e726d3510c7e8e3ded71a8964e8e418d989d8718441175b108315f5f62a30f8369b304c2cb0e038a07058898d4c17fde784c1e06ff77f1f41e2b8c4ed286f68e5b4f1a01b340d5b207b3744e2dc05869b51fa8a5ab131a385d2c43cf11d19e83ae3e349dfa00c673f8d100da84c0b993ad762028a9087438c2d14e32b2fca335f3a0c9cdd834fbf6f52152b424caf2506dcfb015fa409fd471cba5dab1e27716e3d527c0d1fd1413674bbde2586577d20bf9c355a14c64fe2ad508e80a88f6bd5d8369838c29686bf86080298daefbe227bcdcad7cfc8a29d4ec3e63b4a01d3a1e79db250bcdc60359beb8a7443fcc730b2ff1f06e5a91ea54bb82c952bf3aedc909e3e0e63ac8ba7bf3cd85fbb46d5cf10cb245755950b44ceeb8fbef88270f833453c3bcb802c22050644d28ad336915681197808dcb9c8a5512bcec790dda5adc4ca9fc38562be2b0f9c08ac3029579516cc090ab52e7ab76fc6f78d4aaaca194e15450c330101e2d8eccc822a986d17a9d24b674204d0a449fe15480b24a2771cf556b8777fab701f5786c60768f9a34f8a18bb0f5615a9172ec4121b82ea827a912c7448ebd54ae3a10e87e0b9300df87b0d0f1cbec4ea8a6f90e27e6dc60c1ff3676ad119d38e57554065d55f276567ce45b1c0ab98cc045ae693b30b9b79fa0fed3ffddc957796be9e238917030305ed1332e20f86c899e5d3ededc5fe5615dcc5af92b0dd0e5131075fe5c4dee203293fe94591f4d23e69b4a701109d20dd08d7088023646855a3318c5996b0f704445143e80af868ae67e967e625e8fbe25b449444b82bfc8232ea9adcbe290b4ed9f845f9b04e54f54577544738f1cccccb02dd29ecbe0dd17914eeb9d4eb640bdaac9bb28ddadbc60fd28d745687567dd74703b80c995f675537fe2b8c4f3d47b2c445ae07a91ecfa111deb3a40da246913123938dce77a8b7a54a8ac346a607fdd6a9e11eabff1a1d4f525bdea4eabcae456dc85e2f37cbf63c36f76a7a530c822555a01a7ac5357574f17088045eb4a82672eda719602ca98dcfd51fb1939869063c78338ad6242fdcbcf7877e41070738337025a9c662ec86df82099a3424650963480934fad19353af714239900fb9a5f2c9b5264ceee0487c5ef72a22a2660415064c397c0c615870f8b22a9acd5c8e9be38e40cefc9825ba0a62b52573de51b79a5bc01d4216bbfc40d23aaafd63f0576c704012c3fb05dc33b6bb10270beb2d0bf696f43e4386badf1aa8f989dcc046c3631046abc7a6be18ebe2aa7d5420296f3baa82d0abba1f10d65485629fe48194635f26c36cf701f19f67b16d49411134d69034e4945c02e3c3a04ad6f3acd65e31d38f5d13338ff72bb1b4392630356a55124e1ba51e4f741a6e20fc482e1ffa0f9f9273d70bde5754f8dac5f5c9024bfa6b3953d3e1a43800e94094e35e5ed99d1a1453c9c6bb8ae89e68579558cab812d043f32dbd89c931d99b6b30f9a52c6426dea67a91acc9bf10da068a4042029073e1f085e3811918a37902e8cf1a0ea62b5bb9baa0a3dcb6d83ad932e8e4b82f68decf6c6d1079d74315a4cc6417a6540c9fe1bf3d04c0919c715fc12474a9b1a5e829151778188f2ae75b5e9b59f692b0d2011bd60528feee70239b3f7c467bdfe471465afd2d721d1bfdbd0d8f08995a3ca5a904307fec7527df23261c91d8ba8e403a46dd710e88944347f72a3c8e47a2e300f0ec6da19d0a6a6712edc2bfd13b6ddff3d0d71c528045a7d9eeabde5a5a7b2af8e244fbfc44287ea21492cc59fd4354a016e250c1cd8d1d23965e3fafbaa35e86cd9b792844f5ecaf619fbb45250300c80e005b7bef1c1507d788ef7329470ee1c7ba68bbf907a6f11553929ea828b176fc35b40b32cc44ebf171ee88aba394fc1e747bd55745f9e31d9bdac531211f7b8f4cd9f570fc7d20a7e2eaaaefcca364ae53af427f3b9a2188aefcdf2b80c97cab6fdb7942568cdedcef5049ec6b54095900116217e8e1296400fbf8f04995101060bf327a337ad57c2aa6258b6003a0f862296258d55fa6a32f5595f99123462d6325fe977509bd629454c330b3b6d972ec12c628f7a814bca4d90d4ee7fde5fb79ce27f98fa2b82282d70042974b513366ee8a3759a85dd5b1146da78ba2bacd4d14ef68e79834d4be8e8edcebd44251e8edfe1ba5d94056f4b790f697a846e6e1025e49be76b39840fe044ca65746760c1a862e361e82f9638e9c9c996c23d5b0375e89429bba5002d1e1f213d051240bdb65a005804240c89d42fa201f7f61f412df461801e8c6ab6f6ede8de2d3a90714b94682eb97f53971494b2772e29bb323696d979c2535e3ccc3381041520f6851a827f90034cdedc8932298bc134ac2250050aead9218cd53564004f963fff9829a9345389799ef5871c45c18e5ea17d97a2933fdd06ccefcd1eb95a67df51c6491cf18393563747448d51334b11e769c06895ed0433791621f0c8a1d481f4325342ba5f35e3788ac27ef2b6b1ff3a91d4ad3bebe2945fe610a5189eeaaa1c2f5b1769abe2ba439d79bcabdc969861d9cfec62f8b96ccac643f64426648fc66552c73608a229f4c3def39219d2bf253078373779aaebe05badd0c8a6abe18003e50da3ffe9ccc9793b5e9ecf2688274a8264d273a22f63196b075bf4790b5668519f5385df73522e52a169abb8cac65eb096a209cd29d232cc0594c21d2bfbad33a3881b99ccf2d1b5bf1581f8e5d05520320f2fbe1c482c71c0a5a51b0623f486368263dbb97749058139dc327c781b9d7239319b3e5e0a3d6db743c3e889e3c028ee4100a5e95083bd43614c33befa63017030305ed845007450f29599feab31cb23082188c6cb5bcd8df344e2ecdb234cb5e7d9a5cbf639e2d10b64952010cfdaf1f99617a5ed266b2c71969ba98fa314d2451dac1af1506525f82d167dcf01115f9201708ae7de71df5ffb2998c8b44cc3380a68ed46f99795e97e22bca896f0df4b3bb71d90dc3ffb79956ec13b6fb747f7ad889234e18d88979c29c833eb88df4e87f7843f13e037142d094bd79559f403cffb8c827f841e2f7198c30024544f91971b27cae6cea7f1e6fc770b5a8ac85cbc3e6261f52b3b089e183c5afa5140a8992b01d7486a301211953de5471c8afc31d3b2b3d30583c1ca7f7aae4d4b131df70e9995e04825627fe7d1b1adb4656b8dd9cbb34d8e8ffa0e459aa6e31f7f0195b05ab2d8da30fc6b6580b0d5cf69df5fe803524f0244a7e4ffd45da717b7253e59be87b312fc2abfaaaeda7576f25f5c473f5b355e494e6d22292a207bf20b517764b6ef1f43083217cc7a529062f72b1b49be1d2f5ad43fe69f18b097dc3874f0b60b458ab122f686edd4730b58e285c2dbc5f4b1f19152ab9f81df604b03b812139b4d974c8202282062ba1ab19658d4f58a5eb59a1776ecf99adaabaf49b3a1fb0cee4e8ddea741a18aa9446966f77e56e4a4b5fdc354e546f711f41ac6837539db8af98d15c31f30554942c0881f2bdaa2fcf3742d2fc874775a1ce3b7a9296b2abc16fd14c7ed3da4b9aa1698a1beb9e39dc1828341ee28da38e2de9881ac80db5b2c59ef486e37c4d5e49c6f75f63ad303b38c0039a9737938ed88e237fe1bd1692b75da9727ba68ec6908d19aa630017d89f7e851f9ea6a677fecaa0eca5ebeaf460e26cc0f5d40f0afe457f967ee2e18517e78bbf5511c645337f507a154ea62419e5f638f176d23471c8f2fb3a111fd917172b5e61584e3168966f01e69b8a7676348031f36559dfeedb475acf228f095d8c2cb7a509dc5fb6e03200f9e4c69537f2797507090c2ae29e113f5b14d3d7b51008e53c0a4c66663f70a2664640e0f200dcd18bfb8f429d1af49b13e8acef52c00a69260f26834800df7425cdaa538a6bb56f311704f137869f8c3e2b91113936a12d2e333ea0cbfbc6b84e9fe440681c24c8b056c0e0c372965d7c5f3721fc2a14d73fe61f068a41e6bfb517dbeb32b0ad8ab4b64cafa0ff2a24b1b595035cf70a5e73d9b4c252889d5c50df8f852516eb0b57f8b64607d1014f4a0fbdd36d2c3e1fdbfcad4b58977b52d741e2a999cbc87310c4a3331b13cf117de31e37286758d85c006ac4380f7667dc4be7ffaa4a4c788a44ab3cbf7fb40304d6d6db32c0847fc2c456f0730c0b995c3de147d3bd453f03407015966ea16b33d1bf8eb55e6d250500c3a9f9462f250452e087e4db730d8dceb8395b582985d5b4d96a88c5a82555c3d002acee02972977a886007c9907c87e3e2d19b9eb24f940169f78955f71ead3fdea3ffd97fec9e3367f886a786120d39f80b82b5f949a155636ce046aaab39690bad4a5c055c96dc8ec53b8ea488cf03c8b23b198b9c648858b7ca8c3dfa5ac8d6ebe421bd3cea6b13d94752afcf8281ddf3dc3b46c805236389b07cf320826f31fa87c7d780243fac67ac22ef0230b5e831c96a9c25b59663c8d0f77fcd561045e24dfbcece24c7656fe4dba11244610298ac3fe1350919bd5257d8e7ae555ba08c66fad308fa406c76494754cb9d2f02224265e575db0a6210c82c57890896c42b84b5df4e8b50be785b001a2a58ba207dd808e3c53b891cf7ee2b76100d146d5134cb0a5b63b0621e339c604734248c913acbfd5eb5e12f7bcf2992097f454a00551a8ac7d73dbac30d998c0f561ca1f24f36ea5207551357385f55b6c6697b1909e2684cc08770914bd478920ed04abce8c52e075bdc438461b4dda01687a3abca6113f158e293fcb13a0cf86fce5d9688edbf16237eb5b8286322e2ca40082ac4900aa978b60dd0f3d6731dfd838d42cd311a5d618acd8ffd6ed60425ae6a692abca78082ea3463956d38bad3df5c4a8e0d2a711c4a5afa6ae3476f8c592fd900954107a7c362bd309343641262ea10317eb3ecc4deacbb38227cd305213d623c12d2dcf726366b272a7b35865b12c26233790a3355e8733910b075e60338d9501170303054ff93f04616db13251a1167437f7a7cc33c4b1a9c606e1d4f31e311739c5c624b21defd83ed84742e34b2e1ba254a4eff019202d92c110248ab93f73813e357f60ae044b690a1f4481d4515616db4e0ca0e1775fbd08d61c51e2bb60270de3646a0548046c56bbbadfbc170d9f8e053d94f1aba35855ab1bd384230101a94dc46b534188c4a37a80f6f7b2f4b6a952eaba07d001eb685cbccb10201a1827b175f8b7f3f34e2a2badfcfb1dde0f88d0d7068a11e11f118f5dd0fb2819569403bf08d08486f9f0ae5fe3642a86abe20f5a328bc1ba89288c7e7dc6f131463cc738283c39636fce224bca88e00dd404cb8c81387a18b18e9ccc08fe26e5c2633f67362e6467a5dd8e48eb218a6a371d0b977e0e2e1f5a56addb86f91951ff211f4f24bd94dcefe25beeec4a512492808ab0cb4d23db7254c0a9124b1db044a1176d7b453028a38d17bf5b6979397a36302848f39b0df9543b5f4d2d3a98b19523650cd17a401bab53e578d07404c11a9e67c3d0ffe6bed638ac1e6680a9de78b633fec11b57523e477b511ffc780049dfb8362e3a4ab3349078e74c3ff1792111473560b8d77e1d0dcb744c48d72852afc30695f35688f85af00341acc2045e6bd9f712592fbafef13d22c289257d5c188112c59a77b4550fc749bcc0e650c4b0814db2e9b9103d0e24c459bfaf81eead714c0f331677081dc14cacbdc83d429c7c6271b52ad9b6a73ceb14b9371fdabd66e381752ff9558077cc3574ec7eeeffb04551d3f85dd6d3ca2e32ea0636adc89eb49b036d7df3d56e7db214a12e3ed7b63d0fcb8e4494d006fe9a4ba39bf8ef335f495e15476170ad7e0550582df06c461b21a7f6ef292094fc2ac426d111aab8ab404dfbc7b49fecdf690dafc7bd07941a0738b6b2f2a1f8703423d97e946b249237bc2091e60317da7636717c10c17d02853a434f75c7a510321ae7e73593cef006f3da15b9a52a185ecbc0f7955d98ba6f274007fe7ece4426187a956014a2adc63eff0afef1aeae965084dda8d6f2475bd676f0d099b586632265ef95fc4ba1ebcfd20697225c91af0b85cf9e32b75d4537c3fbdd2c8b2f94cfe329795d78e16d8a7a194c99319d0fc1e40c8537e7cabf365f128393ba9875a92769972899450c6e5e6f69fbba4533e9d96b43fa6a03bdaf098914c8d021b74d16018c69ab5db7adc60c0edab87d2831a378906cc08ea5903d1480c24839d3d56d7c8330e59ff69dcff4bb84cc7937411a5cb1a13f39613c6793cba7f182246aadfd704001e15aaf2f522e5240c21972fd7c10fb86b3c80cd0567d74188dc2e3f2278da16230e4585938b2e130aae2794072b0a3c36443eff5de963123752f8038b3194777d1599a1ca64feb1e1dc0920ea907983564e0f64e599ad2347c99323947136af5cbd28f905ab1d416b7f1141e41175d76bbef04020daab7bffa60a3992deef8f7ed34bf6ff877d02977eeb066a1bb40bdbbb6b3736810e4ef15c9bcfa0bbb42ae7347afafb6b93305f2b031a0de0c003b9a6cda1a7991c9399288bc99fe0d09a857736705326c76ec768d549d4f81126cb68c40bb5aa35a4ffe6278b4a5a9073b9643925cfcbe1f6654620180c9a3d03a8920c95bfbe46f03ec5788c245faaa0c876174f7ac8e20a95a9c15f43ed621cad9416ab899d802bf94466579f453aa627da1b5e8649a98f1c26e96d1f4bad23b2c3ce5bf16385bcb24c29d1c5887324a000ab0ef3bdcc27fe4773f5cc6ae687319ab827ec69c5ae97b423e95b8f8a27e450ca5d34b68cfe58941e51aa501729f196c366de076764c4a64eb7d2a5908e1eab26ca615e3e02389412decea8ec938349b718379d3164be55289c9ffb9ee6adb0be7056bbd384e1aebb40bfb0f24e8d4b8ea6588807b89446e5d9a1a55771e").unwrap();

    let cell = TokenValue::write_bytes(&tls_data, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let cert: Vec<u8> = hex::decode("03c9308203c5308202ada003020102021002ac5c266a0b409b8f0b79f2ae462577300d06092a864886f70d0101050500306c310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d312b30290603550403132244696769436572742048696768204173737572616e636520455620526f6f74204341301e170d3036313131303030303030305a170d3331313131303030303030305a306c310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d312b30290603550403132244696769436572742048696768204173737572616e636520455620526f6f7420434130820122300d06092a864886f70d01010105000382010f003082010a0282010100c6cce573e6fbd4bbe52d2d32a6dfe5813fc9cd2549b6712ac3d5943467a20a1cb05f69a640b1c4b7b28fd098a4a941593ad3dc94d63cdb7438a44acc4d2582f74aa5531238eef3496d71917e63b6aba65fc3a484f84f6251bef8c5ecdb3892e306e508910cc4284155fbcb5a89157e71e835bf4d72093dbe3a38505b77311b8db3c724459aa7ac6d00145a04b7ba13eb510a984141224e656187814150a6795c89de194a57d52ee65d1c532c7e98cd1a0616a46873d03404135ca171d35a7c55db5e64e13787305604e511b4298012f1793988a202117c2766b788b778f2ca0aa838ab0a64c2bf665d9584c1a1251e875d1a500b2012cc41bb6e0b5138b84bcb0203010001a3633061300e0603551d0f0101ff040403020186300f0603551d130101ff040530030101ff301d0603551d0e04160414b13ec36903f8bf4701d498261a0802ef63642bc3301f0603551d23041830168014b13ec36903f8bf4701d498261a0802ef63642bc3300d06092a864886f70d010105050003820101001c1a0697dcd79c9f3c886606085721db2147f82a67aabf183276401057c18af37ad911658e35fa9efc45b59ed94c314bb891e8432c8eb378cedbe3537971d6e5219401da55879a2464f68a66ccde9c37cda834b1699b23c89e78222b7043e35547316119ef58c5852f4e30f6a0311623c8e7e2651633cbbf1a1ba03df8ca5e8b318b6008892d0c065c52b7c4f90a98d1155f9f12be7c366338bd44a47fe4262b0ac497690de98ce2c01057b8c876129155f24869d8bc2a025b0f44d42031dbf4ba70265d90609ebc4b17092fb4cb1e4368c90727c1d25cf7ea21b968129c3c9cbf9efc805c9b63cdec47aa252767a037f300827d54d7a9f8e92e13a377e81f4a").unwrap();

    let cell = TokenValue::write_bytes(&cert, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let lv_kid: Vec<u8> = hex::decode("14996af12848fc796cb61a6ab287e4b01dbd78a82f").unwrap();

    let cell = TokenValue::write_bytes(&lv_kid, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let timestamp: Vec<u8> = vec![0, 0, 3, 232];
    let cell = TokenValue::write_bytes(&timestamp, &ABI_VERSION_2_4).unwrap().into_cell().unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));

    // Push args, func name, instance name, then wasm.
    let wasm_func = "tlscheck";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_func = "docs:tlschecker/tls-check-interface@0.1.0";
    let cell = pack_data_to_cell(&wasm_func.as_bytes(), &mut engine).unwrap();
    engine.cc.stack.push(StackItem::cell(cell.clone()));
    let wasm_dict = Vec::<u8>::new();

    let cell = TokenValue::write_bytes(&wasm_dict.as_slice(), &ABI_VERSION_2_4)
        .unwrap()
        .into_cell()
        .unwrap();

    engine.cc.stack.push(StackItem::cell(cell.clone()));

    let status = execute_run_wasm_concat_multiarg(&mut engine).unwrap();
    println!("Wasm Return Status: {:?}", status);

    let res = engine.cc.stack.get(0).as_cell().unwrap(); //engine.cc.stack.get(0).as_slice().unwrap().clone();
    let slice = SliceData::load_cell(res.clone()).unwrap();
    let ress = unpack_data_from_cell(slice, &mut engine).unwrap();

    assert_eq!(
        "0100000000689fb76aa8cdd763e2175db4b267e9c6e14a506f7169475fc0af54decde9fb04316826f0e56cc54d19c80a8a1fe24c404420d09ec9288ca46fbfcd9e80dd19f6accdc0b4519b775019e139ba001b1e62cad6ad021605892c49b1e778fca40497621a001de52b8fa1ad5ae4834191da3ef2345bce28fb49d3a3ea4a6ccedbd314facaed71558bf47bd4ea8c792944c3c5daa0add41784423aa660f3acd8a1d4ec0e6535a2714f762f6e0be41c6ef36079f1e307a309adf04ffb761aa8bbc66f5bcacc74c84655f3f3bed93206b70c30bf93069195f1c9d51b2e59f6d226ab9a92f473578221456143e0c45065f50d930a1807ca24702e4b045589c8353f80383f608288c3",
        hex::encode(ress.clone())
    );

    println!("ress: {:?}", hex::encode(ress));
}
